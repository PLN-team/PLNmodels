<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clustering of multivariate count data with PLN-mixture • PLNmodels</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Clustering of multivariate count data with PLN-mixture">
<meta property="og:description" content="PLNmodels">
<meta property="og:image" content="https://pln-team.github.io/PLNmodels/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PLNmodels</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.11.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="https://pln-team.github.io/slideshow/slides">Slideshow on PLN</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Trichoptera.html">The trichoptera data set</a>
    </li>
    <li>
      <a href="../articles/Import_data.html">Data importation in PLNmodels</a>
    </li>
    <li>
      <a href="../articles/PLN.html">PLN: Multivariate Poisson regression</a>
    </li>
    <li>
      <a href="../articles/PLNPCA.html">PLNPCA: Dimension Reduction</a>
    </li>
    <li>
      <a href="../articles/PLNnetwork.html">PLNnetwork: sparse structure inference</a>
    </li>
    <li>
      <a href="../articles/PLNLDA.html">PLNLDA: Discriminant Analysis</a>
    </li>
    <li>
      <a href="../articles/PLNmixture.html">PLNmixture: Model-based clustering for counts</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pln-team/PLNmodels/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="PLNmixture_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Clustering of multivariate count data with PLN-mixture</h1>
                        <h4 class="author">PLN team</h4>
            
            <h4 class="date">2021-03-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pln-team/PLNmodels/blob/master/vignettes/PLNmixture.Rmd"><code>vignettes/PLNmixture.Rmd</code></a></small>
      <div class="hidden name"><code>PLNmixture.Rmd</code></div>

    </div>

    
    
<div id="preliminaries" class="section level2">
<h2 class="hasAnchor">
<a href="#preliminaries" class="anchor"></a>Preliminaries</h2>
<p>This vignette illustrates the standard use of the <code>PLNmixture</code> function and the methods accompanying the R6 Classes <code>PLNmixturefamily</code> and <code>PLNmixturefit</code>.</p>
<div id="requirements" class="section level3">
<h3 class="hasAnchor">
<a href="#requirements" class="anchor"></a>Requirements</h3>
<p>The packages required for the analysis are <strong>PLNmodels</strong> plus some others for data manipulation and representation:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pln-team.github.io/PLNmodels/">PLNmodels</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.sthda.com/english/rpkgs/factoextra">factoextra</a></span><span class="op">)</span></code></pre></div>
<p>The main function <code>PLNmixture</code> integrates some features of the <strong>future</strong> package to perform parallel computing: we set our plan now to speed the fit by relying on 2 workers:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/future">future</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
</div>
<div id="data-set" class="section level3">
<h3 class="hasAnchor">
<a href="#data-set" class="anchor"></a>Data set</h3>
<p>We illustrate our point with the trichoptera data set, a full description of which can be found in <a href="Trichoptera.html">the corresponding vignette</a>. Data preparation is also detailed in <a href="Import_data.html">the specific vignette</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">trichoptera</span><span class="op">)</span>
<span class="va">trichoptera</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">trichoptera</span><span class="op">$</span><span class="va">Abundance</span>, <span class="va">trichoptera</span><span class="op">$</span><span class="va">Covariate</span><span class="op">)</span></code></pre></div>
<p>The <code>trichoptera</code> data frame stores a matrix of counts (<code>trichoptera$Abundance</code>), a matrix of offsets (<code>trichoptera$Offset</code>) and some vectors of covariates (<code>trichoptera$Wind</code>, <code>trichoptera$Temperature</code>, etc.)</p>
</div>
<div id="mathematical-background" class="section level3">
<h3 class="hasAnchor">
<a href="#mathematical-background" class="anchor"></a>Mathematical background</h3>
<p>PLN-mixture for multivariate count data is a variant of the Poisson Lognormal model of <span class="citation">Aitchison and Ho (<a href="#ref-AiH89" role="doc-biblioref">1989</a>)</span> (see <a href="PLN.html">the PLN vignette</a> as a reminder) which can be viewed as a PLN model with an additional mixture layer in the model: the latent observations found in the first layer are assumed to be drawn from a mixture of <span class="math inline">\(K\)</span> multivariate Gaussian components. Each component <span class="math inline">\(k\)</span> has a prior probability <span class="math inline">\(p(i \in k) = \pi_k\)</span> such that <span class="math inline">\(\sum_k \pi_k = 1\)</span>. We denote by <span class="math inline">\(C_i\in \{1,\dots,K\}\)</span> the multinomial variable <span class="math inline">\(\mathcal{M}(1,\boldsymbol{\pi} = (\pi_1,\dots,\pi_K))\)</span> describing the component to which observation <span class="math inline">\(i\)</span> belongs to. Introducing this additional layer, our PLN mixture model is as follows</p>
<p><span class="math display">\[
\begin{array}{rcl}
\text{layer 2 (clustering)} &amp; \mathbf{C}\_i \sim \mathcal{M}(1,\boldsymbol{\pi}) \\
\text{layer 1 (Gaussian)} &amp; \mathbf{Z}\_i | \, \mathbf{C}\_i = k
\sim \mathcal{N}({\boldsymbol\mu}^{(k)},
{\boldsymbol\Sigma}^{(k)}), \\ 
\text{observation space } &amp; Y_{ij} \| Z_{ij} \quad \text{indep.} &amp; \mathbf{Y}_i |
\mathbf{Z}_i\sim\mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right).
\end{array}
\]</span></p>
<div id="covariates-and-offsets" class="section level4">
<h4 class="hasAnchor">
<a href="#covariates-and-offsets" class="anchor"></a>Covariates and offsets</h4>
<p>Just like PLN, PLN-mixture generalizes to a formulation where the main effect is due to a linear combination of <span class="math inline">\(d\)</span> covariates <span class="math inline">\(\mathbf{x}_i\)</span> and to a vector <span class="math inline">\(\mathbf{o}_i\)</span> of <span class="math inline">\(p\)</span> offsets in sample <span class="math inline">\(i\)</span> in each mixture component. The latent layer then reads</p>
<p><span class="math display">\[
\mathbf{Z}_i | \mathbf{C}_i = k \, \sim
\mathcal{N}({\mathbf{o}_i +
\mathbf{x}_i^{\top}{\boldsymbol\Theta} + \boldsymbol\mu}^{(k)},{\boldsymbol\Sigma}^{(k)}),
\]</span></p>
<p>where <span class="math inline">\({\boldsymbol\Theta}\)</span> is a <span class="math inline">\(d\times p\)</span> matrix of regression parameters common to all the mixture components.</p>
</div>
<div id="parametrization-of-the-covariance-of-the-mixture-models" class="section level4">
<h4 class="hasAnchor">
<a href="#parametrization-of-the-covariance-of-the-mixture-models" class="anchor"></a>Parametrization of the covariance of the mixture models</h4>
<p>When using parametric mixture models like Gaussian mixture models, it is generally not recommended to have covariances matrices <span class="math inline">\({\boldsymbol\Sigma}^{(k)}\)</span> with no special restriction, especially when dealing with a large number of variables. Indeed, the total number of parameters to estimate in such unrestricted model can become prohibitive.</p>
<p>To reduce the computational burden and avoid over-fitting the data, two different, more constrained parametrizations of the covariance matrices of each component are currently implemented in the <code>PLNmodels</code> package (on top of the general form of <span class="math inline">\(\Sigma_k\)</span>):</p>
<span class="math display">\[\begin{equation*}
\begin{array}{rrcll}
    \text{diagonal covariances:} &amp; \Sigma_k &amp; = &amp;\mathrm{diag}({d}_k) &amp; \text{($2 K p$ parameters),} \\[1.5ex]
    \text{spherical covariances:} &amp; \Sigma_k &amp; = &amp;  \sigma_k^2 {I} &amp; \text{($K (p + 1)$ parameters).} 
\end{array}
\end{equation*}\]</span>
<p>The diagonal structure assumes that, given the group membership of a site, all variable abundances are independent. The spherical structure further assumes that all species have the same biological variability. In particular, in both parametrisations, all observed covariations are caused only by the group structure.</p>
<p>For readers familiar with the <code>mclust</code> <code>R</code> package <span class="citation">(Fraley and Raftery <a href="#ref-fraley1999" role="doc-biblioref">1999</a>)</span>, which implements Gaussian mixture models with many variants of covariance matrices of each component, the spherical model corresponds to <code>VII</code> (spherical, unequal volume) and the diagonal model to <code>VVI</code> (diagonal, varying volume and shape). {Using constrained forms of the covariance matrices enables} PLN-mixture to {provide a clustering} even when the number of sites <span class="math inline">\(n\)</span> remains of the same order, or smaller, than the number of species <span class="math inline">\(p\)</span>.</p>
</div>
<div id="optimization-by-variational-inference" class="section level4">
<h4 class="hasAnchor">
<a href="#optimization-by-variational-inference" class="anchor"></a>Optimization by Variational inference</h4>
<p>Just like with all models fitted in PLNmodels, we adopt a variational strategy to approximate the log-likelihood function and optimize the consecutive variational surrogate of the log-likelihood with a gradient-ascent-based approach. In this case, it is not too difficult to show that PLN-mixture can be obtained by optimizing a collection of weighted standard PLN models.</p>
</div>
</div>
</div>
<div id="analysis-of-trichoptera-data-with-a-pln-mixture-model" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis-of-trichoptera-data-with-a-pln-mixture-model" class="anchor"></a>Analysis of trichoptera data with a PLN-mixture model</h2>
<p>In the package, the PLN-mixture model is adjusted with the function <code>PLNmixture</code>, which we review in this section. This function adjusts the model for a series of value of <span class="math inline">\(k\)</span> and provides a collection of objects <code>PLNmixturefit</code> stored in an object with class <code>PLNmixturefamily</code>.</p>
<p>The class <code>PLNmixturefit</code> contains a collection of components constituting the mixture, each of whom inherits from the class <code>PLNfit</code>, so we strongly recommend the reader to be comfortable with <code>PLN</code> and <code>PLNfit</code> before using <code>PLNmixture</code> (see <a href="PLN.html">the PLN vignette</a>).</p>
<div id="a-mixture-model-with-a-latent-main-effects-for-the-trichoptera-data-set" class="section level3">
<h3 class="hasAnchor">
<a href="#a-mixture-model-with-a-latent-main-effects-for-the-trichoptera-data-set" class="anchor"></a>A mixture model with a latent main effects for the Trichoptera data set</h3>
<div id="adjusting-a-collection-of-fits" class="section level4">
<h4 class="hasAnchor">
<a href="#adjusting-a-collection-of-fits" class="anchor"></a>Adjusting a collection of fits</h4>
<p>We fit a collection of <span class="math inline">\(K=4\)</span> models as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mixture_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLNmixture.html">PLNmixture</a></span><span class="op">(</span>
  <span class="va">Abundance</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Offset</span><span class="op">)</span><span class="op">)</span>,
  data  <span class="op">=</span> <span class="va">trichoptera</span>,
  clusters <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>
<span class="op">)</span></code></pre></div>
<pre><code>## 
##  Initialization...
## 
##  Adjusting 5 PLN mixture models.
##  number of cluster = 1 
    number of cluster = 2 
    number of cluster = 3 
    number of cluster = 4 
    number of cluster = 5 
## 
##  Smoothing PLN mixture models.
##    Going backward ++++
                                                                                                    
   Going forward ++++
                                                                                                    
   Going backward ++++
                                                                                                    
   Going forward ++++
                                                                                                    
##  Post-treatments
##  DONE!</code></pre>
<p>Note the use of the <code>formula</code> object to specify the model, similar to the one used in the function <code>PLN</code>.</p>
</div>
<div id="structure-of-plnmixturefamily" class="section level4">
<h4 class="hasAnchor">
<a href="#structure-of-plnmixturefamily" class="anchor"></a>Structure of <code>PLNmixturefamily</code>
</h4>
<p>The <code>mixture_models</code> variable is an <code>R6</code> object with class <code>PLNmixturefamily</code>, which comes with a couple of methods. The most basic is the <code>show/print</code> method, which outputs a brief summary of the estimation process:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mixture_models</span></code></pre></div>
<pre><code>## --------------------------------------------------------
## COLLECTION OF 5 POISSON LOGNORMAL MODELS
## --------------------------------------------------------
##  Task: Mixture Model 
## ========================================================
##  - Number of clusters considered: from 1 to 5 
##  - Best model (regarding BIC): cluster = 5 
##  - Best model (regarding ICL): cluster = 5</code></pre>
<p>One can also easily access the successive values of the criteria in the collection</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mixture_models</span><span class="op">$</span><span class="va">criteria</span> <span class="op">%&gt;%</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">param</th>
<th align="right">nb_param</th>
<th align="right">loglik</th>
<th align="right">BIC</th>
<th align="right">ICL</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">18</td>
<td align="right">-1398.668</td>
<td align="right">-1433.695</td>
<td align="right">-1891.7060</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">37</td>
<td align="right">-1282.496</td>
<td align="right">-1354.495</td>
<td align="right">-1670.0608</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">56</td>
<td align="right">-1185.427</td>
<td align="right">-1294.398</td>
<td align="right">-1194.4714</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">75</td>
<td align="right">-1121.563</td>
<td align="right">-1267.507</td>
<td align="right">-866.3668</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">94</td>
<td align="right">-1079.735</td>
<td align="right">-1262.650</td>
<td align="right">-824.3451</td>
</tr>
</tbody>
</table>
<p>A quick diagnostic of the optimization process is available via the <code>convergence</code> field:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mixture_models</span><span class="op">$</span><span class="va">convergence</span>  <span class="op">%&gt;%</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">param</th>
<th align="left">nb_param</th>
<th align="left">objective</th>
<th align="left">convergence</th>
<th align="left">outer_iterations</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">out</td>
<td align="right">1</td>
<td align="left">18</td>
<td align="left">1398.668455</td>
<td align="left">0.000005</td>
<td align="left">2.000000</td>
</tr>
<tr class="even">
<td align="left">elt</td>
<td align="right">2</td>
<td align="left">37</td>
<td align="left">1282.496253</td>
<td align="left">0.000000</td>
<td align="left">2.000000</td>
</tr>
<tr class="odd">
<td align="left">elt.1</td>
<td align="right">3</td>
<td align="left">56</td>
<td align="left">1185.427134</td>
<td align="left">0.000009</td>
<td align="left">2.000000</td>
</tr>
<tr class="even">
<td align="left">elt.2</td>
<td align="right">4</td>
<td align="left">75</td>
<td align="left">1121.563286</td>
<td align="left">0.000013</td>
<td align="left">2.000000</td>
</tr>
<tr class="odd">
<td align="left">elt.3</td>
<td align="right">5</td>
<td align="left">94</td>
<td align="left">1079.734927</td>
<td align="left">0.000009</td>
<td align="left">2.000000</td>
</tr>
</tbody>
</table>
<p>A visual representation of the optimization can be obtained be representing the objective function</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mixture_models</span><span class="op">$</span><span class="fu">plot_objective</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="PLNmixture_files/figure-html/objective-1.png" width="700"></p>
<p>Comprehensive information about <code>PLNmixturefamily</code> is available via <code><a href="../reference/PLNmixturefamily.html">?PLNmixturefamily</a></code>.</p>
</div>
<div id="model-selection" class="section level4">
<h4 class="hasAnchor">
<a href="#model-selection" class="anchor"></a>Model selection</h4>
<p>The <code>plot</code> method of <code>PLNmixturefamily</code> displays evolution of the criteria mentioned above, and is a good starting point for model selection:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mixture_models</span><span class="op">)</span></code></pre></div>
<p><img src="PLNmixture_files/figure-html/plot%20nocov-1.png" width="672"></p>
<p>Note that we use the original definition of the BIC/ICL criterion (<span class="math inline">\(\texttt{loglik} - \frac{1}{2}\texttt{pen}\)</span>), which is on the same scale as the log-likelihood. A <a href="https://en.wikipedia.org/wiki/Bayesian_information_criterion">popular alternative</a> consists in using <span class="math inline">\(-2\texttt{loglik} + \texttt{pen}\)</span> instead. You can do so by specifying <code>reverse = TRUE</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mixture_models</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="PLNmixture_files/figure-html/plot%20nocov-reverse-1.png" width="672"></p>
<p>From those plots, we can see that the best model in terms of BIC is obtained for a number of clusters of 5. We may extract the corresponding model with the method <code><a href="../reference/getBestModel.PLNPCAfamily.html">getBestModel()</a></code>. A model with a specific number of clusters can also be extracted with the <code><a href="../reference/getModel.PLNPCAfamily.html">getModel()</a></code> method:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myMix_BIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getBestModel.PLNPCAfamily.html">getBestModel</a></span><span class="op">(</span><span class="va">mixture_models</span>, <span class="st">"BIC"</span><span class="op">)</span>
<span class="va">myMix_2</span>   <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getModel.PLNPCAfamily.html">getModel</a></span><span class="op">(</span><span class="va">mixture_models</span>, <span class="fl">2</span><span class="op">)</span></code></pre></div>
</div>
<div id="structure-of-plnmixturefit" class="section level4">
<h4 class="hasAnchor">
<a href="#structure-of-plnmixturefit" class="anchor"></a>Structure of <code>PLNmixturefit</code>
</h4>
<p>Object <code>myMix_BIC</code> is an <code>R6Class</code> object with class <code>PLNmixturefit</code> which in turns has a couple of methods. A good place to start is the <code>show/print</code> method:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myMix_BIC</span></code></pre></div>
<pre><code>## Poisson Lognormal mixture model with 5 components and spherical covariances.
## * Useful fields
##     $posteriorProb, $memberships, $mixtureParam, $group_means
##     $model_par, $latent, $latent_pos, $optim_par
##     $loglik, $BIC, $ICL, $loglik_vec, $nb_param, $criteria
##     $component[[i]] (a PLNfit with associated methods and fields)
## * Useful S3 methods
##     print(), coef(), sigma(), fitted(), predict()</code></pre>
</div>
<div id="specific-fields" class="section level4">
<h4 class="hasAnchor">
<a href="#specific-fields" class="anchor"></a>Specific fields</h4>
<p>The user can easily access several fields of the <code>PLNmixturefit</code> object using active binding or <code>S3</code> methods:</p>
<ul>
<li>the vector of group memberships:</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myMix_BIC</span><span class="op">$</span><span class="va">memberships</span></code></pre></div>
<pre><code>##  [1] 1 1 4 4 4 1 1 4 1 1 1 1 4 1 4 4 1 1 1 1 1 1 1 1 1 3 3 1 1 2 2 5 5 5 1 1 1 1
## [39] 1 4 1 1 1 1 1 1 1 1 3</code></pre>
<ul>
<li>the group proportions:</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myMix_BIC</span><span class="op">$</span><span class="va">mixtureParam</span></code></pre></div>
<pre><code>## [1] 0.67346939 0.04081633 0.06122449 0.16326531 0.06122449</code></pre>
<ul>
<li>the posterior probabilities (often close to the boundaries <span class="math inline">\(\{0,1\}\)</span>):</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myMix_BIC</span><span class="op">$</span><span class="va">posteriorProb</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<table class="table"><tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody></table>
<ul>
<li>a list of <span class="math inline">\(K\)</span> <span class="math inline">\(p \times p\)</span> covariance matrices <span class="math inline">\(\hat{\boldsymbol{\Sigma}}\)</span> (here spherical variances):</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span><span class="op">(</span><span class="va">myMix_BIC</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">as.matrix</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">diag</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
##        Che        Hyc        Hym        Hys        Psy        Aga        Glo 
## 0.05717905 0.05717905 0.05717905 0.05717905 0.05717905 0.05717905 0.05717905 
##        Ath        Cea        Ced        Set        All        Han        Hfo 
## 0.05717905 0.05717905 0.05717905 0.05717905 0.05717905 0.05717905 0.05717905 
##        Hsp        Hve        Sta 
## 0.05717905 0.05717905 0.05717905 
## 
## [[2]]
##        Che        Hyc        Hym        Hys        Psy        Aga        Glo 
## 0.04218818 0.04218818 0.04218818 0.04218818 0.04218818 0.04218818 0.04218818 
##        Ath        Cea        Ced        Set        All        Han        Hfo 
## 0.04218818 0.04218818 0.04218818 0.04218818 0.04218818 0.04218818 0.04218818 
##        Hsp        Hve        Sta 
## 0.04218818 0.04218818 0.04218818 
## 
## [[3]]
##        Che        Hyc        Hym        Hys        Psy        Aga        Glo 
## 0.05016157 0.05016157 0.05016157 0.05016157 0.05016157 0.05016157 0.05016157 
##        Ath        Cea        Ced        Set        All        Han        Hfo 
## 0.05016157 0.05016157 0.05016157 0.05016157 0.05016157 0.05016157 0.05016157 
##        Hsp        Hve        Sta 
## 0.05016157 0.05016157 0.05016157 
## 
## [[4]]
##          Che          Hyc          Hym          Hys          Psy          Aga 
## 0.0003991058 0.0003991058 0.0003991058 0.0003991058 0.0003991058 0.0003991058 
##          Glo          Ath          Cea          Ced          Set          All 
## 0.0003991058 0.0003991058 0.0003991058 0.0003991058 0.0003991058 0.0003991058 
##          Han          Hfo          Hsp          Hve          Sta 
## 0.0003991058 0.0003991058 0.0003991058 0.0003991058 0.0003991058 
## 
## [[5]]
##        Che        Hyc        Hym        Hys        Psy        Aga        Glo 
## 0.05124919 0.05124919 0.05124919 0.05124919 0.05124919 0.05124919 0.05124919 
##        Ath        Cea        Ced        Set        All        Han        Hfo 
## 0.05124919 0.05124919 0.05124919 0.05124919 0.05124919 0.05124919 0.05124919 
##        Hsp        Hve        Sta 
## 0.05124919 0.05124919 0.05124919</code></pre>
<ul>
<li>the regression coefficient matrix and other model of parameters (results not shown here, redundant with other fields)</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, <span class="st">'main'</span><span class="op">)</span>       <span class="co"># equivalent to myMix_BIC$model_par$Theta</span>
<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, <span class="st">'mixture'</span><span class="op">)</span>    <span class="co"># equivalent to myMix_BIC$model_par$Pi, myMix_BIC$mixtureParam</span>
<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, <span class="st">'means'</span><span class="op">)</span>      <span class="co"># equivalent to myMix_BIC$model_par$Mu, myMix_BIC$group_means</span>
<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, <span class="st">'covariance'</span><span class="op">)</span> <span class="co"># equivalent to myMix_BIC$model_par$Sigma, sigma(myMix_BIC)</span></code></pre></div>
<ul>
<li>the <span class="math inline">\(p \times K\)</span> matrix of group means <span class="math inline">\(\mathbf{M}\)</span>
</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myMix_BIC</span><span class="op">$</span><span class="va">group_means</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">group_1</th>
<th align="right">group_2</th>
<th align="right">group_3</th>
<th align="right">group_4</th>
<th align="right">group_5</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Che</td>
<td align="right">-6.50</td>
<td align="right">-16.54</td>
<td align="right">-19.54</td>
<td align="right">-7.08</td>
<td align="right">-19.86</td>
</tr>
<tr class="even">
<td align="left">Hyc</td>
<td align="right">-7.19</td>
<td align="right">-8.42</td>
<td align="right">-5.16</td>
<td align="right">-66.08</td>
<td align="right">-19.86</td>
</tr>
<tr class="odd">
<td align="left">Hym</td>
<td align="right">-2.37</td>
<td align="right">-6.00</td>
<td align="right">-3.77</td>
<td align="right">-4.30</td>
<td align="right">-2.75</td>
</tr>
<tr class="even">
<td align="left">Hys</td>
<td align="right">-5.39</td>
<td align="right">-16.54</td>
<td align="right">-19.54</td>
<td align="right">-66.08</td>
<td align="right">-19.86</td>
</tr>
<tr class="odd">
<td align="left">Psy</td>
<td align="right">-0.58</td>
<td align="right">-0.21</td>
<td align="right">-1.26</td>
<td align="right">-0.16</td>
<td align="right">-0.70</td>
</tr>
<tr class="even">
<td align="left">Aga</td>
<td align="right">-3.58</td>
<td align="right">-7.32</td>
<td align="right">-19.54</td>
<td align="right">-3.47</td>
<td align="right">-2.88</td>
</tr>
</tbody>
</table>
<p>In turn, each component of a <code>PLNmixturefit</code> is a <code>PLNfit</code> object (see the corresponding <a href="PLN.html">vignette</a>)</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">myMix_BIC</span><span class="op">$</span><span class="va">components</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code>## A multivariate Poisson Lognormal fit with spherical covariance model.
## ==================================================================
##  nb_param   loglik      BIC      ICL
##        18 -625.404 -660.431 -693.402
## ==================================================================
## * Useful fields
##     $model_par, $latent, $latent_pos, $var_par, $optim_par
##     $loglik, $BIC, $ICL, $loglik_vec, $nb_param, $criteria
## * Useful S3 methods
##     print(), coef(), sigma(), vcov(), fitted(), predict(), standard_error()</code></pre>
<p>The <code>PLNmixturefit</code> class also benefits from two important methods: <code>plot</code> and <code>predict</code>.</p>
</div>
<div id="plot-method" class="section level4">
<h4 class="hasAnchor">
<a href="#plot-method" class="anchor"></a><code>plot</code> method</h4>
<p>We can visualize the clustered latent position by performing a PCA on the latent layer:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, <span class="st">"pca"</span><span class="op">)</span></code></pre></div>
<p><img src="PLNmixture_files/figure-html/plot%20clustering-1.png" width="700"></p>
<p>We can also plot the data matrix with samples reordered by clusters to check whether it exhibits strong pattern or not. The limits between clusters are highlighted by grey lines.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, <span class="st">"matrix"</span><span class="op">)</span></code></pre></div>
<p><img src="PLNmixture_files/figure-html/plot%20reordered%20data-1.png" width="700"></p>
</div>
<div id="predict-method" class="section level4">
<h4 class="hasAnchor">
<a href="#predict-method" class="anchor"></a><code>predict</code> method</h4>
<p>For PLNmixture, the goal of <code>predict</code> is to predict the membership based on observed newly <em>species counts</em>.</p>
<p>By default, the <code>predict</code> use the argument <code>type = "posterior"</code> to output the matrix of posterior probabilities <span class="math inline">\(\hat{\pi}_k\)</span></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted.class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, newdata <span class="op">=</span> <span class="va">trichoptera</span><span class="op">)</span>
<span class="co">## equivalent to </span>
<span class="co">## predicted.class &lt;- predict(myMIX_BIC, newdata = trichoptera,  type = "posterior")</span>
<span class="va">predicted.class</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<table class="table"><tbody>
<tr class="odd">
<td align="right">1.00</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">0.69</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.02</td>
<td align="right">0.30</td>
</tr>
<tr class="odd">
<td align="right">0.00</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.99</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">0.00</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
</tr>
<tr class="odd">
<td align="right">0.00</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">0.39</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0.54</td>
<td align="right">0.07</td>
</tr>
</tbody></table>
<p>Setting <code>type = "response"</code>, we can predict the most likely cluster <span class="math inline">\(\hat{k} = \arg\max_{k = 1\dots K} \{ \hat{\pi_k}\}\)</span> instead:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted.class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, newdata <span class="op">=</span> <span class="va">trichoptera</span>, 
                           prior <span class="op">=</span> <span class="va">myMix_BIC</span><span class="op">$</span><span class="va">posteriorProb</span>,  type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>
<span class="va">predicted.class</span></code></pre></div>
<pre><code>##  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
##  1  1  4  4  4  1  1  4  1  1  1  1  4  1  4  4  1  1  1  1  1  1  1  1  1  3 
## 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 
##  3  1  3  2  2  5  5  5  1  1  1  1  1  4  1  1  1  1  1  1  1  1  3 
## Levels: 1 2 3 4 5</code></pre>
<p>We can assess that the predictions are quite similar to the real group (<em>this is not a proper validation of the method as we used data set for both model fitting and prediction and are thus at risk of overfitting</em>).</p>
<p>Finally, we can get the coordinates of the new data on the same graph at the original ones with <code>type = "position"</code>. This is done by averaging the latent positions <span class="math inline">\(\hat{\mathbf{Z}}_i + \boldsymbol{\mu}_k\)</span> (found when the sample is assumed to come from group <span class="math inline">\(k\)</span>) and weighting them with the <span class="math inline">\(\hat{\pi}_k\)</span>. Some samples, have compositions that put them very far from their group mean.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predicted.position</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">myMix_BIC</span>, newdata <span class="op">=</span> <span class="va">trichoptera</span>, 
                              prior <span class="op">=</span> <span class="va">myMix_BIC</span><span class="op">$</span><span class="va">posteriorProb</span>, type <span class="op">=</span> <span class="st">"position"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">predicted.position</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">factoextra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/factoextra/man/fviz_pca.html">fviz_pca_ind</a></span><span class="op">(</span>col.ind <span class="op">=</span> <span class="va">predicted.class</span><span class="op">)</span></code></pre></div>
<p><img src="PLNmixture_files/figure-html/predicted_position-1.png" width="672"></p>
</div>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-AiH89">
<p>Aitchison, J., and C. H. Ho. 1989. “The Multivariate Poisson-Log Normal Distribution.” <em>Biometrika</em> 76 (4): 643–53.</p>
</div>
<div id="ref-fraley1999">
<p>Fraley, Chris, and Adrian E. Raftery. 1999. “MCLUST: Software for Model-Based Cluster Analysis.” <em>Journal of Classification</em> 16 (2): 297–306. <a href="https://doi.org/10.1007/s003579900058">https://doi.org/10.1007/s003579900058</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Julien Chiquet, Mahendra Mariadassou, François Gindraud.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
