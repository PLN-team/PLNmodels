---
title: 'PLNmodels: an R package for analyzing multivariate count data'
description: |
  In many fields of life science, count data is becoming the standard, like abundance table in ecology and microbiology, or single-cell data in molecular biology. The Poisson lognormal model is a latent model that describes the dependency structure of the data in an underlying Gaussian layer, while the observation layer of the count is Poisson distributed. As such, it offers the flexibility of the multivariate Gaussian distribution while preserving count distributions. <br/>
  &emsp; In the `R` package **PLNmodels** we implement an efficient variational strategy for inferring the multivariate Poisson lognormal model. We derive a series of models by transposing the classical tools of multivariate analysis, mostly tight to the Gaussian assumption of the data, to count data. **PLNmodels** includes variants for Principal Component Analysis, Discriminant Analysis, sparse covariance estimation (_a.k.a._ network inference), and hopefully more coming, all designed for multivariate count data. <div class='altmetric-embed' data-badge-type='donut' data-doi="10.1007/s11222-010-9191-2"></div>
preview: https://github.com/jchiquet/PLNmodels/raw/master/inst/sticker/PLNmodels.png
author:
  - name: Julien Chiquet 
    url: http://julien.cremeriefamily.info
    affiliation: MIA Paris, INRA
    affiliation_url: https://www6.inra.fr/mia-paris
  - name: Mahendra Mariadassou
    url: https://mahendra-mariadassou.github.io/
    affiliation: MaIAGE, INRA
    affiliation_url: http://maiage.jouy.inra.fr/
  - name: St√©phane Robin
    url: https://www6.inra.fr/mia-paris/Equipes/Membres/Stephane-Robin
    affiliation: MIA Paris, INRA
    affiliation_url: https://www6.inra.fr/mia-paris
date: "`r Sys.Date()`"
journal: 
  title: "Journal of something"
  issue: x
  volume: x
  doi: ""
slug: PLNmodels
output:
  radix::radix_article:
    toc: true
bibliography: PLNreferences.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  eval = FALSE, ## Avoid pkgdown
  echo = TRUE,
  rows.print = 5,
  layout = "l-page",
  message = FALSE, 
  warning = FALSE)
library(tidyverse)
library(rmarkdown)
library(PLNmodels)
library(plotly)
library(gridExtra)
```

!!! Work in Progress !!!

## Introduction

In many fields of life science, count data is becoming the standard, like abundance table in ecology and microbiology, or single-cell data in molecular biology. Even if not explicitly stated, most of the standard tools of multivariate analysis (Principal component analysis, Linear Discriminant Analysis, multivariate linear regression or Gaussian Graphical Models, see e.g. [@MKB79]), assume a multivariate Gaussian distribution of the data. The goal of **PLNmodels** is to offer a set of functions based on the multivariate Poisson Lognormal (in short PLN) models to perform standard tasks of multivariate analysis with table of counts, thus in a non-Gaussian setting. For now, the top-level functions found in the package allow the user to perform the following analyses

<aside>
![PLNmodels](../../man/figures/logo.png)
</aside>

 - Multivariate Regression
 - Dimension Reduction via probabilistic Poisson PCA
 - Discriminant Analysis
 - Structure Inference and sparse covariance estimation

This article quickly reviews the mathematical aspect of the PLN model and its variants. We briefly describe the algorithm used to adjust these models, which is based on a variational strategy. Then, we illustrate the use of the top level functions by performing various multivariate analysis on a simple companion dataset from ecology that fulfills the typical characteristics of count data. To support our point, let us start introducing this data set.

### `mollusc`: a motivating companion data set

The order Trichoptera (or caddisflies) are a group of insects with aquatic larvae and terrestrial adults. The ecological data set trichoptera [@trichoptera] describes abundances of Trichopetera species (hereafter the _counts_), accompanied with some meteological factors (hereafter the _covariates_) that may have influenced their presence during the sampling^[The original version is available in the **ade4** package. We consider here a different version where we only keep a subset of the original meteorological features, for illutrative purposes]. 

<aside>
```{r trichoptera, echo = FALSE, fig.cap = "Macronema Zebratum captured by Y. Dubuc at Donacona, 06-20-2001."}
knitr::include_graphics("figures/macronema_zebratum.jpg")
```
</aside>

The data is directly available once **PLNmodels** is loaded. Comprehensive information and description are available to the user with `?PLNmodels::trichoptera`. Data are stored in the `trichoptera` data frame which includes 49 rows (the observations - or trapping nights) and 9 columns. There are 2 multivariate columns (matrices of counts and offsets) and 7 univariate columns (vectors of covariates). 

<aside>
```{r data load}
library(PLNmodels)
data(trichoptera)
```
</aside>


#### Table of counts (abundancies)

The `Abundance` column is a $49 \times 17$ matrix of abundancies (or counts) for each 17 species during the 49 trapping nights 

<aside>
The count table is denoted by $\mathbf{Y}$ in the mathematical model and `Y` in the `R` environment
</aside>

```{r responses_trichoptera}
trichoptera$Abundance %>% as.data.frame() %>% paged_table()
```

#### Covariates (external meteorological effect, groups)

Additional information were collected during the sampling, which corresponds to external covariates the effect of which may or may not be taken into account in the model, depending on the question at play. In the trichoptera data set, those covariates correspond to meteorological factors plus a categorical variable indicating the family of the caughts specimens.

<aside>
The design matrix arising from the covariates is denoted by $\mathbf{X}$ in the mathematical mdoel and `X` within the `R` environment. 
</aside>

```{r covariates_trichoptera}
select(trichoptera, -TotalCounts, -Abundance) %>% paged_table()
```


#### Compositionality issue, sampling effort and offsets

A common issue with (microbiological) ecological data is the compositionality problem: counts can only be compared to each other within a sample but not across samples as they depend on a sample-specific size-factor, which may induce spurious negative correlations of its own. Besides, the sampling of some particular species  may be biased. Those technical biases can be encoded in a $49 \times 17$ matrix of offsets. In the case at hand, we have a natural offset observation that corresponds to the total counts per night, specified by a $49 \times 17$ matrix of offsets^[Note that the offset term remains the same in a given sample albeit sometimes one might include an offset specific to both the sample and the species.] (matrix $\mathbf{O}$ in  model). The corresponding column is named `TotalCounts` in the data frame: 

<aside>
Sampling effort or technical biaises are store in matrix $\mathbf{O}$ in the mathematical model and variable `O` in the `R` environment.
</aside>

```{r offset_trichopera}
trichoptera$TotalCounts %>% as.data.frame() %>% paged_table()
```

## Statistical Framework

### The multivariate Poisson Lognormal model

The multivariate Poisson lognormal model (in short PLN, see [@AiH89]) is the building block for all the multivariate models found in the **PLNmodels** package. It relates some $p$-dimensional observation vectors $\mathbf{Y}_i$ to some  $p$-dimensional vectors of Gaussian latent variables $\mathbf{Z}_i$ as follows

\begin{equation}
  (\#eq:pln-model)
  \begin{array}{rcl}
  \text{latent space } &   \mathbf{Z}_i \sim \mathcal{N}({\boldsymbol\mu},\boldsymbol\Sigma), \\
  \text{observation space } &  Y_{ij} | Z_{ij} \quad \text{indep.} &   \mathbf{Y}_i | \mathbf{Z}_i\sim\mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right).
  \end{array}
\end{equation}

The parameter ${\boldsymbol\mu}$ corresponds to the main effects and the latent covariance matrix $\boldsymbol\Sigma$ describes the underlying structure of dependence between the $p$ variables. Figure \@ref(fig:geometricalInsight) provides insights about the role played by the different layers

```{r geometricalInsight, layout="l-screen-inset shaded", echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "PLN: geometrical view", fig.width=16, fig.height=4}
set.seed(20171110)
x <- rnorm(100)
y <- rnorm(100)
b <- data.frame(x = x + y, y = y) / 1
mu <- 0
##
data.perfect <- as.data.frame((b + matrix(rep(mu, each = length(x)), ncol = 2)))
p.latent <- ggplot(data.perfect, aes(x, y)) + geom_point() + ggtitle(expression(Latent~Space~(Z)))
.rpois <- function(lambda) {
  unlist(lapply(exp(lambda), function(x) {rpois(1, x)}))
}
observation <- as.data.frame(lapply(data.perfect, .rpois))
mapped.parameter <- as.data.frame(lapply(data.perfect, exp))
## segment between mapped and observed data
segment.data <- cbind(mapped.parameter, observation)
names(segment.data) <- c("x", "y", "xend", "yend")
## Mapped parameters
p.mapped <- ggplot(mapped.parameter, aes(x, y)) + geom_point(col = "red") + ggtitle(expression(Observation~Space~(exp(Z))))
## Observations only
obs <- group_by(observation, x, y)
obs <- dplyr::summarize(obs, count = n())
p.observation.only <- ggplot(obs, aes(x, y)) +
  geom_point(aes(size = count)) +
  ggtitle(Observation~Space~(Y)~+'noise') +
  theme(legend.position = c(.95, .95), legend.justification = c(1, 1),
        legend.background = element_rect(color = "transparent"),
        legend.box.background = element_blank())
## Observations and latent parameters
p.observation.mixed <- p.observation.only +
  geom_point(data = mapped.parameter, color = "red", alpha = 0.5) +
  geom_segment(data = segment.data, aes(xend = xend, yend = yend), color = "black", alpha = 0.2) +
  ggtitle(Observation~Space~(Y==P(exp(Z)))~+'noise')

grid.arrange(p.latent + labs(x = "species 1", y = "species 2"),
             p.mapped  + labs(x = "species 1", y = "species 2"),
             p.observation.mixed + labs(x = "species 1", y = "species 2"),
             p.observation.only + labs(x = "species 1", y = "species 2"),
             ncol = 4)
```

#### Acccounting for covariates and offsets in a GLM-like fashion

Count tables  -- like abundace data -- often come with some external knowledge (via covariates and offsets) which should be taken into account during the fits. To this end, model \eqref{eq:pln-model} generalizes naturally to a formulation closer to a multivariate generalized linear model, where the main effect is due to a linear combination of $d$ covariates $\mathbf{x}_i$. We also let the possibility to add some offsets for the $d$ variables and in each sample., that is $\mathbf{o}_i$. Hence, model \@ref(eq:pln-model) generalizes to

\begin{equation}
  (\#eq:pln-model-glm)
  \mathbf{Y}_i | \mathbf{Z}_i \sim \mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right), \qquad \mathbf{Z}_i \sim \mathcal{N}({\mathbf{o}_i + \mathbf{x}_i^\top\boldsymbol\Theta},\boldsymbol\Sigma), \\
\end{equation}
where $\boldsymbol\Theta$ is a $d\times p$ matrix of regression parameters. When all individuals $i=1,\dots,n$ are stacked together, the data matrices available to feed the model are

  - the $n\times p$ matrix of counts  $\mathbf{Y}$
  - the $n\times p$ matrix of design  $\mathbf{X}$
  - the $n\times p$ matrix of offsets $\mathbf{O}$

#### GLM notation

We naturally recourse to the `R` `formulas` system to specified our model. A typical call to a a fitting function in **PLNmodels** uses formulas of the form

```{r formulas general, eval = FALSE}
Y ~ 1 + X1 + X2 + X1:X2 + offset(log(O))
```

where `Y` stands for the matrix of observed counts, `X1` and `X2` are two vector of covariates and `O` is a matrix of offsets with the same dimension as `Y`. Note the use of the `log` function _within_ the `offset` function to specify the offset term, as it is the way with GLM-Poisson family of models.

### PLN variants 

All PLN variants found are avatars of model \eqref{eq:pln-model} (or its glm-like version \eqref{eq:pln-model-glm}). The general idea is to impose some additional constraints in the model that will 

#### Principal Component Analysis

The model can be written in a hierachical framework where a sample of $p$-dimensional observation vectors $\mathbf{Y}_i$ is related to some  $q$-dimensional vectors of latent variables $\mathbf{W}_i$ as follows
\begin{equation} 
  \label{eq:pca-model}
  \begin{array}{rcl}
    \text{latent space }  & \mathbf{W}_i \quad \text{i.i.d.} & \mathbf{W}_i \sim      \mathcal{N}(\mathbf{0}_q, \mathbf{I}_q)  \\
\text{parameter space } &   \mathbf{Z}_i = {\boldsymbol\mu} + \mathbf{B}^\top \mathbf{W}_i & \\
  \text{observation space } &  Y_{ij} | Z_{ij} \quad \text{indep.} & Y_{ij} | Z_{ij} \sim \mathcal{P}\left(\exp\{Z_{ij}\}\right)
  \end{array}
\end{equation}

The parameter ${\boldsymbol\mu}$ corresponds to the main effects, $\mathbf{B}$ to \emph{rescaled} loadings in the parameter spaces and $\mathbf{W}_i$ to scores of the $i$-th observation in the low-dimensional latent subspace of the parameter space. For more details, have a look at our research paper referenced in the package documentation.

The dimension of the latent space $q$ corresponds to the number of axes in the PCA or, in other words, to the rank of $\mathbf{B}\mathbf{B}^\intercal$.

#### Sparse covariance estimation and network

In the PLN network, we penalized the inverse covariance $\boldsymbol\Sigma^{-1} = \boldsymbol\Theta$ by a $\ell_1$ penalty to induce sparsity and select important direct relationships between entities. Hence, the support of $\boldsymbol\Theta$ correspond to a network of underlying interactions. All mathematical details can be found in @PLNnetwork.

#### Discriminant Analysis

[...]

### Variational inference and optimization

A few words

## Step-by-step analysis of an ecological dataset

### Multivariate Regression with `PLN`

### Dimension Reduction with `PLNPCA`

### Structure / Network inference with `PLNnetwork`

### Discriminant Analysis with `PLNLDA`

## Acknowledgments {.appendix}

This is a place to recognize people and institutions. It may also be a good place
to acknowledge and cite software that makes your work possible.

## Author Contributions {.appendix}

We strongly encourage you to include an author contributions statement briefly 
describing what each author did.

