#!/bin/bash
# Julien Chiquet (2018-19) mainly stolen from Anticonf scripts by Jeroen Ooms
#
# This script will query 'pkg-config' for the required cflags and ldflags.

PKG_CONFIG_NAME="nlopt"
PKG_DEB_NAME="libnlopt-dev"
PKG_DEB_TESTING_NAME="libnlopt-cxx-dev"
PKG_RPM_NAME="NLopt-devel"
PKG_BREW_NAME="nlopt"
PKG_TEST_HEADER="<nlopt.h>"

# Check if pkg-config
pkg-config --version >/dev/null 2>&1
if [ $? -eq 0 ]; then
  NLOPT_LIBS=`pkg-config --libs ${PKG_CONFIG_NAME}`
  NLOPT_FLAG=`pkg-config --cflags ${PKG_CONFIG_NAME}`
fi

# Find compiler
CXX=`${R_HOME}/bin/R CMD config CXXCPP`
CXX11=`${R_HOME}/bin/R CMD config CXX11STD`
CXXFLAGS=`${R_HOME}/bin/R CMD config CXXFLAGS`

# # # Avoid OpenMP for MAC OS
# # if [[ "$OSTYPE" == "darwin"* ]]; then
# #   OPENMP_FLAG=''
# # else
# #   OPENMP_FLAG='$(SHLIB_OPENMP_CXXFLAGS)'
# # fi

# NLOPT_LIBS=`${R_HOME}/bin/Rscript -e "nloptr:::LdFlags()"`
# NLOPT_FLAG=`${R_HOME}/bin/Rscript -e "nloptr:::CFlags()"`
#
# For debugging
echo "Using NLOPT_LIBS=$NLOPT_LIBS"
echo "Using NLOPT_FLAG=$NLOPT_FLAG"

echo "${CXX} ${CXX11} ${CXXFLAGS} ${OPENMP_FLAGS} ${NLOPT_FLAG}"

# Test configuration
echo "#include $PKG_TEST_HEADER" > tmp.hpp
${CXX} ${CXX11} ${CXXFLAGS} ${OPENMP_FLAGS} ${NLOPT_FLAG} tmp.hpp >/dev/null 2>&1 || R_CONFIG_ERROR=1;
rm tmp.hpp

# g++ -E -std=gnu++11 -g -O2 -fdebug-prefix-map=/build/r-base-i39faS/r-base-3.5.2=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -g

if [ $R_CONFIG_ERROR ]; then
  echo "------------------------- ANTICONF ERROR ---------------------------"
  echo "Configuration failed because $PKG_CONFIG_NAME was not found. Try installing:"
  echo " * deb: sudo apt-get install $PKG_DEB_NAME (Debian, Ubuntu)"
  echo " * deb: sudo apt-get install $PKG_DEB_TESTING_NAME (Debian Sid)"
  echo " * rpm: sudo yum install $PKG_RPM_NAME (Fedora, EPEL)"
  echo " * brew: brew install $PKG_RPM_NAME (MacOS with brew)"
  echo " * otherwise: not yet available"
  echo "Also check that pkg-config is installed."
  echo "--------------------------------------------------------------------"
  exit 1;
fi

# Write to Makevars
sed -e "s|@nlopt_libs@|$NLOPT_LIBS|" -e "s|@nlopt_flag@|$NLOPT_FLAG|" -e "s|@openmp_flag@|$OPENMP_FLAG|" src/Makevars.in > src/Makevars

# Success
exit 0
